name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment:
          # ESP32-S3 boards
          - heltec_v3_v0only
          - heltec_v3_v1only
          - heltec_v3
          - heltec_v3_ble
          - heltec_v4
          - heltec_wireless_stick_lite_v3
          - heltec_wireless_tracker
          - heltec_wireless_paper
          - heltec_vision_master_t190
          - heltec_vision_master_e213
          - heltec_vision_master_e290
          - lilygo_t3s3
          - lilygo_t3s3_ble
          - lilygo_t3s3_eink
          - lilygo_tbeam_supreme
          - lilygo_tdeck
          - lilygo_tdeck_pro
          - lilygo_tlora_pager
          - lilygo_twatch_s3
          - station_g2
          - seeed_sensecap_indicator
          - seeed_xiao_esp32s3
          - thinknode_m2
          - thinknode_m5
          - crowpanel_35tft
          - crowpanel_43tft
          - crowpanel_24tft
          - rak3312
          - ebyte_eora_s3
          - tracksenger_small
          - tracksenger_big
          - pi_computer_s3
          - unphone
          # nRF52840 boards
          - lilygo_techo
          - rak4631
          - rak_wismesh_repeater
          - rak_wismesh_tap
          - rak_wismesh_tag
          - rak3401_1w
          - heltec_mesh_node_t114
          - heltec_mesh_pocket
          - seeed_tracker_t1000e
          - seeed_xiao_nrf52840
          - seeed_sensecap_solar
          - seeed_wio_tracker_l1
          - seeed_wio_tracker_l1_eink
          - seeed_wio_wm1110
          - thinknode_m1
          - thinknode_m3
          - nano_g2_ultra
          - muzi_base
          - muzi_r1_neo
          - nomadstar_meteor_pro
          - canary_one
          - nrf52_promicro_diy
          # ESP32 (original) boards
          - lilygo_tbeam
          - lilygo_tlora_v21_16
          - lilygo_tlora_v21_18
          - nano_g1
          - nano_g1_explorer
          - station_g1
          - rak11200
          - radiomaster_900_bandit
          - m5stack
          - diy_v1
          - hydra
          # ESP32-C3 boards
          - heltec_ht62
          # ESP32-C6 boards
          - m5stack_unit_c6l
          # RP2040 boards
          - rak11310
          - rp2040_lora
          - rpi_pico
          - rpi_pico_w

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build ${{ matrix.environment }}
        run: |
          pio run -e ${{ matrix.environment }}

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          # Find and copy firmware files
          if [ -f .pio/build/${{ matrix.environment }}/firmware.bin ]; then
            cp .pio/build/${{ matrix.environment }}/firmware.bin release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.bin
          fi
          if [ -f .pio/build/${{ matrix.environment }}/firmware.elf ]; then
            cp .pio/build/${{ matrix.environment }}/firmware.elf release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.elf
          fi
          if [ -f .pio/build/${{ matrix.environment }}/firmware.hex ]; then
            cp .pio/build/${{ matrix.environment }}/firmware.hex release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.hex
          fi
          if [ -f .pio/build/${{ matrix.environment }}/firmware.uf2 ]; then
            cp .pio/build/${{ matrix.environment }}/firmware.uf2 release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.uf2
          fi

      - name: Generate SHA256 checksums
        run: |
          cd release-artifacts
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.environment }}
          path: release-artifacts/
          retention-days: 90

  create-release:
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release directory
        run: |
          mkdir -p release-files
          # Combine all artifacts into a single directory
          find all-artifacts -type f -exec cp {} release-files/ \;
          cd release-files
          # Create a combined checksums file
          cat *.sha256 > SHA256SUMS.txt
          echo "Release files prepared:"
          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true
          make_latest: true
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## meshgrid Firmware ${{ github.ref_name }}

            Firmware binaries for all supported boards with SHA256 checksums.

            ### Download Instructions

            Download the firmware file for your board and verify the SHA256 checksum:

            ```bash
            # Download firmware for your board (example: lilygo-t3s3)
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin

            # Download checksum
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin.sha256

            # Verify checksum
            sha256sum -c meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin.sha256
            ```

            Or use meshgrid-cli:
            ```bash
            meshgrid-cli flash lilygo-t3s3
            ```

            ### Supported Boards

            See the full list of firmware files in the Assets section below.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
