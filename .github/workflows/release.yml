name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment:
          # ESP32-S3 boards
          - heltec_v3_v0only
          - heltec_v3_v1only
          - heltec_v3
          - heltec_v3_ble
          - heltec_v4
          - heltec_wireless_stick_lite_v3
          - heltec_wireless_tracker
          - heltec_wireless_paper
          - heltec_vision_master_t190
          - heltec_vision_master_e213
          - heltec_vision_master_e290
          - lilygo_t3s3
          - lilygo_t3s3_ble
          - lilygo_t3s3_eink
          - lilygo_tbeam_supreme
          - lilygo_tdeck
          - lilygo_tdeck_pro
          - lilygo_tlora_pager
          - lilygo_twatch_s3
          - station_g2
          - seeed_sensecap_indicator
          - seeed_xiao_esp32s3
          - thinknode_m2
          - thinknode_m5
          - crowpanel_35tft
          - crowpanel_43tft
          - crowpanel_24tft
          - rak3312
          - ebyte_eora_s3
          - tracksenger_small
          - tracksenger_big
          - pi_computer_s3
          - unphone
          # nRF52840 boards - DISABLED (require NVS storage abstraction)
          # - lilygo_techo
          # - rak4631
          # - rak_wismesh_repeater
          # - rak_wismesh_tap
          # - rak_wismesh_tag
          # - rak3401_1w
          # - heltec_mesh_node_t114
          # - heltec_mesh_pocket
          # - seeed_tracker_t1000e
          # - seeed_xiao_nrf52840
          # - seeed_sensecap_solar
          # - seeed_wio_tracker_l1
          # - seeed_wio_tracker_l1_eink
          # - seeed_wio_wm1110
          # - thinknode_m1
          # - thinknode_m3
          # - nano_g2_ultra
          # - muzi_base
          # - muzi_r1_neo
          # - nomadstar_meteor_pro
          # - canary_one
          # - nrf52_promicro_diy
          # ESP32 (original) boards
          - lilygo_tbeam
          - lilygo_tlora_v21_16
          - lilygo_tlora_v21_18
          - nano_g1
          - nano_g1_explorer
          - station_g1
          - rak11200
          - radiomaster_900_bandit
          - m5stack
          - diy_v1
          - hydra
          # ESP32-C3 boards
          - heltec_ht62
          # ESP32-C6 boards - DISABLED (no Arduino framework support yet)
          # - m5stack_unit_c6l
          # RP2040 boards - DISABLED (board definitions not in PlatformIO registry)
          # - rak11310
          # - rp2040_lora
          # - rpi_pico
          # - rpi_pico_w

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build ${{ matrix.environment }}
        run: |
          pio run -e ${{ matrix.environment }}

      - name: Install esptool
        run: |
          pip install esptool

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          BUILD_DIR=".pio/build/${{ matrix.environment }}"

          # Check if this is an ESP32 board (has bootloader.bin)
          if [ -f "$BUILD_DIR/bootloader.bin" ] && [ -f "$BUILD_DIR/partitions.bin" ] && [ -f "$BUILD_DIR/firmware.bin" ]; then
            echo "Creating merged binary for ESP32 board..."

            # Auto-detect chip type from readelf
            if readelf -h "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "xtensa"; then
              # Xtensa-based ESP32
              if readelf -A "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "esp32s3"; then
                CHIP="esp32s3"
              elif readelf -A "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "esp32s2"; then
                CHIP="esp32s2"
              else
                CHIP="esp32"
              fi
            elif readelf -h "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "RISC-V"; then
              # RISC-V based ESP32
              if objdump -f "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "esp32c6"; then
                CHIP="esp32c6"
              elif objdump -f "$BUILD_DIR/firmware.elf" 2>/dev/null | grep -q "esp32c3"; then
                CHIP="esp32c3"
              else
                CHIP="esp32c3"  # default RISC-V to C3
              fi
            else
              # Fallback: detect from environment name
              if echo "${{ matrix.environment }}" | grep -qE "(s3|t3s3|tdeck|v3|v4)"; then
                CHIP="esp32s3"
              elif echo "${{ matrix.environment }}" | grep -qE "(c3|ht62)"; then
                CHIP="esp32c3"
              elif echo "${{ matrix.environment }}" | grep -qE "(c6|c6l)"; then
                CHIP="esp32c6"
              else
                CHIP="esp32"
              fi
            fi

            # Auto-detect flash size from partition table
            if [ -f "$BUILD_DIR/partitions.bin" ]; then
              # Get total size from last partition
              PARTITIONS_SIZE=$(stat -f%z "$BUILD_DIR/partitions.bin" 2>/dev/null || stat -c%s "$BUILD_DIR/partitions.bin" 2>/dev/null || echo "3072")

              # Estimate flash size based on firmware size and partitions
              FIRMWARE_SIZE=$(stat -f%z "$BUILD_DIR/firmware.bin" 2>/dev/null || stat -c%s "$BUILD_DIR/firmware.bin" 2>/dev/null || echo "0")

              # Default flash sizes based on common configurations
              if [ "$FIRMWARE_SIZE" -gt 2000000 ]; then
                FLASH_SIZE="8MB"  # Large firmware needs 8MB+
              elif [ "$FIRMWARE_SIZE" -gt 1000000 ]; then
                FLASH_SIZE="4MB"  # Medium firmware needs 4MB
              else
                FLASH_SIZE="4MB"  # Default to 4MB
              fi
            else
              FLASH_SIZE="4MB"
            fi

            echo "Detected chip: $CHIP, flash size: $FLASH_SIZE"

            # Create merged binary with bootloader + partitions + firmware
            python3 -m esptool \
              --chip $CHIP \
              merge_bin \
              -o release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.bin \
              --flash_mode dio \
              --flash_size $FLASH_SIZE \
              0x0 $BUILD_DIR/bootloader.bin \
              0x8000 $BUILD_DIR/partitions.bin \
              0x10000 $BUILD_DIR/firmware.bin

            echo "âœ“ Merged binary created for $CHIP ($FLASH_SIZE)"
          elif [ -f "$BUILD_DIR/firmware.bin" ]; then
            # Non-ESP32 board or app-only binary
            echo "Copying app-only binary (non-ESP32 or no bootloader)"
            cp $BUILD_DIR/firmware.bin release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.bin
          fi

          # Copy other firmware formats if they exist
          if [ -f "$BUILD_DIR/firmware.elf" ]; then
            cp $BUILD_DIR/firmware.elf release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.elf
          fi
          if [ -f "$BUILD_DIR/firmware.hex" ]; then
            cp $BUILD_DIR/firmware.hex release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.hex
          fi
          if [ -f "$BUILD_DIR/firmware.uf2" ]; then
            cp $BUILD_DIR/firmware.uf2 release-artifacts/meshgrid-${{ matrix.environment }}-${GITHUB_REF_NAME}.uf2
          fi

      - name: Generate SHA256 checksums
        run: |
          cd release-artifacts
          for file in *; do
            sha256sum "$file" > "$file.sha256"
          done

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.environment }}
          path: release-artifacts/
          retention-days: 90

  create-release:
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release directory
        run: |
          mkdir -p release-files
          # Combine all artifacts into a single directory
          find all-artifacts -type f -exec cp {} release-files/ \;
          cd release-files
          # Create a combined checksums file
          cat *.sha256 > SHA256SUMS.txt
          echo "Release files prepared:"
          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true
          make_latest: true
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## meshgrid Firmware ${{ github.ref_name }}

            Firmware binaries for all supported boards with SHA256 checksums.

            ### Download Instructions

            Download the firmware file for your board and verify the SHA256 checksum:

            ```bash
            # Download firmware for your board (example: lilygo-t3s3)
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin

            # Download checksum
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin.sha256

            # Verify checksum
            sha256sum -c meshgrid-lilygo_t3s3-${{ github.ref_name }}.bin.sha256
            ```

            Or use meshgrid-cli:
            ```bash
            meshgrid-cli flash lilygo-t3s3
            ```

            ### Supported Boards

            See the full list of firmware files in the Assets section below.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
