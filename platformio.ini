; meshgrid-firmware - Multi-platform LoRa mesh network firmware
; Linux kernel-style structure

[platformio]
default_envs = heltec_v3
src_dir = src
include_dir = src

[env]
monitor_speed = 115200
lib_ldf_mode = deep+
build_flags =
    -Isrc
    -DMESH_DEBUG=1
    ; Protocol selection (both enabled by default for compatibility)
    -DPROTOCOL_V0_ENABLED=1  ; MeshCore v0 protocol (for compatibility with existing devices)
    -DPROTOCOL_V1_ENABLED=1  ; meshgrid v1 protocol (enhanced protocol)
    ; To build v0-only: comment out PROTOCOL_V1_ENABLED or set to 0
    ; To build v1-only: comment out PROTOCOL_V0_ENABLED or set to 0
lib_deps =
    jgromes/RadioLib@^7.0.0
    rweather/Crypto@^0.4.0  ; For MeshCore v0 (AES, SHA256, HMAC)
    adafruit/Adafruit SSD1306@^2.5.13
    adafruit/Adafruit GFX Library@^1.11.0
    knolleary/PubSubClient@^2.8  ; For optional MQTT support

; Version is set automatically from VERSION file via set_version.py

; =============================================================================
; Protocol-specific build environments (examples)
; =============================================================================

; v0-only build (MeshCore compatibility only)
[env:heltec_v3_v0only]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
board_build.partitions = partitions/partitions_4mb_ota.csv
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_V3
    -DPROTOCOL_V0_ENABLED=1
    -DPROTOCOL_V1_ENABLED=0

; v1-only build (meshgrid enhanced protocol only)
[env:heltec_v3_v1only]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
board_build.partitions = partitions/partitions_4mb_ota.csv
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_V3
    -DPROTOCOL_V0_ENABLED=0
    -DPROTOCOL_V1_ENABLED=1

; =============================================================================
; ESP32-S3 Boards
; =============================================================================

[esp32s3_base]
platform = espressif32
framework = arduino
extra_scripts = pre:set_version.py
build_flags =
    -DARCH_ESP32S3
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

; --- Heltec ESP32-S3 ---

[env:heltec_v3]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
board_build.partitions = partitions/partitions_4mb_ota.csv
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_V3

[env:heltec_v3_ble]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
board_build.partitions = partitions/partitions_4mb_ota.csv
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_V3
    -DENABLE_BLE

[env:heltec_v4]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
board_build.partitions = partitions/partitions_8mb_ota.csv
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_V4
    -DARDUINO_USB_CDC_ON_BOOT=1

[env:heltec_wireless_stick_lite_v3]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_WIRELESS_STICK_LITE_V3

[env:heltec_wireless_tracker]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_WIRELESS_TRACKER

[env:heltec_wireless_paper]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_WIRELESS_PAPER

[env:heltec_vision_master_t190]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_VISION_MASTER_T190

[env:heltec_vision_master_e213]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_VISION_MASTER_E213

[env:heltec_vision_master_e290]
extends = esp32s3_base
board = heltec_wifi_lora_32_V3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_HELTEC_VISION_MASTER_E290

; --- LilyGo ESP32-S3 ---

[env:lilygo_t3s3]
extends = esp32s3_base
board = lilygo-t3-s3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_T3S3
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DARDUINO_RUNNING_CORE=1
    -DARDUINO_EVENT_RUNNING_CORE=1
    -DBOARD_HAS_PSRAM

[env:lilygo_t3s3_ble]
extends = esp32s3_base
board = lilygo-t3-s3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_T3S3
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DARDUINO_RUNNING_CORE=1
    -DARDUINO_EVENT_RUNNING_CORE=1
    -DBOARD_HAS_PSRAM
    -DENABLE_BLE

[env:lilygo_t3s3_eink]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_T3S3_EINK

[env:lilygo_tbeam_supreme]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_TBEAM_SUPREME

[env:lilygo_tdeck]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_TDECK

[env:lilygo_tdeck_pro]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_TDECK_PRO

[env:lilygo_tlora_pager]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_TLORA_PAGER

[env:lilygo_twatch_s3]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_LILYGO_TWATCH_S3

; --- B&Q ESP32-S3 ---

[env:station_g2]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_STATION_G2

; --- Seeed ESP32-S3 ---

[env:seeed_sensecap_indicator]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_SEEED_SENSECAP_INDICATOR

[env:seeed_xiao_esp32s3]
extends = esp32s3_base
board = seeed_xiao_esp32s3
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_SEEED_XIAO_ESP32S3

; --- Elecrow ESP32-S3 ---

[env:thinknode_m2]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_THINKNODE_M2

[env:thinknode_m5]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_THINKNODE_M5

[env:crowpanel_35tft]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_CROWPANEL_35TFT

[env:crowpanel_43tft]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_CROWPANEL_43TFT

[env:crowpanel_24tft]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_CROWPANEL_24TFT

; --- RAK ESP32-S3 ---

[env:rak3312]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_RAK3312

; --- Other ESP32-S3 ---

[env:ebyte_eora_s3]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_EBYTE_EORA_S3

[env:tracksenger_small]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_TRACKSENGER_SMALL

[env:tracksenger_big]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_TRACKSENGER_BIG

[env:pi_computer_s3]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_PI_COMPUTER_S3

[env:unphone]
extends = esp32s3_base
board = esp32-s3-devkitc-1
build_flags =
    ${esp32s3_base.build_flags}
    -DBOARD_UNPHONE

; =============================================================================
; nRF52840 Boards
; =============================================================================

[nrf52840_base]
platform = nordicnrf52
framework = arduino
build_flags =
    -DARCH_NRF52840
    -Os                        ; Size optimization for 1MB flash constraint
    -ffunction-sections        ; Enable dead code elimination
    -fdata-sections
    -DCORE_DEBUG_LEVEL=0      ; Remove debug overhead
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

; --- LilyGo nRF52840 ---

[env:lilygo_techo]
extends = nrf52840_base
board = ttgo_t_echo
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_LILYGO_TECHO

; --- RAK nRF52840 ---

[env:rak4631]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_RAK4631

[env:rak_wismesh_repeater]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_RAK_WISMESH_REPEATER

[env:rak_wismesh_tap]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_RAK_WISMESH_TAP

[env:rak_wismesh_tag]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_RAK_WISMESH_TAG

[env:rak3401_1w]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_RAK3401_1W

; --- Heltec nRF52840 ---

[env:heltec_mesh_node_t114]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_HELTEC_MESH_NODE_T114

[env:heltec_mesh_pocket]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_HELTEC_MESH_POCKET

; --- Seeed nRF52840 ---

[env:seeed_tracker_t1000e]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_TRACKER_T1000E

[env:seeed_xiao_nrf52840]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_XIAO_NRF52840

[env:seeed_sensecap_solar]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_SENSECAP_SOLAR

[env:seeed_wio_tracker_l1]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_WIO_TRACKER_L1

[env:seeed_wio_tracker_l1_eink]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_WIO_TRACKER_L1_EINK

[env:seeed_wio_wm1110]
extends = nrf52840_base
board = seeed_xiao_nrf52840_sense
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_SEEED_WIO_WM1110

; --- Elecrow nRF52840 ---

[env:thinknode_m1]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_THINKNODE_M1

[env:thinknode_m3]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_THINKNODE_M3

; --- B&Q nRF52840 ---

[env:nano_g2_ultra]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_NANO_G2_ULTRA

; --- muzi nRF52840 ---

[env:muzi_base]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_MUZI_BASE

[env:muzi_r1_neo]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_MUZI_R1_NEO

; --- NomadStar nRF52840 ---

[env:nomadstar_meteor_pro]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_NOMADSTAR_METEOR_PRO

; --- Canary nRF52840 ---

[env:canary_one]
extends = nrf52840_base
board = wiscore_rak4631
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_CANARY_ONE

; --- DIY nRF52840 ---

[env:nrf52_promicro_diy]
extends = nrf52840_base
board = adafruit_feather_nrf52840
build_flags =
    ${nrf52840_base.build_flags}
    -DBOARD_NRF52_PROMICRO_DIY

; =============================================================================
; ESP32 (Original) Boards
; =============================================================================

[esp32_base]
platform = espressif32
framework = arduino
extra_scripts = pre:set_version.py
build_flags =
    -DARCH_ESP32
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

; --- LilyGo ESP32 ---

[env:lilygo_tbeam]
extends = esp32_base
board = ttgo-t-beam
board_build.partitions = partitions/partitions_4mb_ota.csv
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_LILYGO_TBEAM
lib_deps =
    jgromes/RadioLib@^7.0.0
    rweather/Crypto@^0.4.0
    adafruit/Adafruit SSD1306@^2.5.13
    adafruit/Adafruit GFX Library@^1.11.0
    lewisxhe/XPowersLib@^0.2.4

[env:lilygo_tlora_v21_16]
extends = esp32_base
board = ttgo-lora32-v21
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_LILYGO_TLORA_V21_16

[env:lilygo_tlora_v21_18]
extends = esp32_base
board = ttgo-lora32-v21
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_LILYGO_TLORA_V21_18

; --- B&Q ESP32 ---

[env:nano_g1]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_NANO_G1

[env:nano_g1_explorer]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_NANO_G1_EXPLORER

[env:station_g1]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_STATION_G1

; --- RAK ESP32 ---

[env:rak11200]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_RAK11200

; --- RadioMaster ESP32 ---

[env:radiomaster_900_bandit]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_RADIOMASTER_900_BANDIT

; --- M5Stack ESP32 ---

[env:m5stack]
extends = esp32_base
board = m5stack-core-esp32
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_M5STACK

; --- DIY ESP32 ---

[env:diy_v1]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_DIY_V1

[env:hydra]
extends = esp32_base
board = esp32dev
build_flags =
    ${esp32_base.build_flags}
    -DBOARD_HYDRA

; =============================================================================
; ESP32-C3 Boards
; =============================================================================

[esp32c3_base]
platform = espressif32
framework = arduino
extra_scripts = pre:set_version.py
build_flags =
    -DARCH_ESP32C3
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

[env:heltec_ht62]
extends = esp32c3_base
board = esp32-c3-devkitm-1
build_flags =
    ${esp32c3_base.build_flags}
    -DBOARD_HELTEC_HT62

; =============================================================================
; ESP32-C6 Boards
; =============================================================================

[esp32c6_base]
platform = espressif32
framework = arduino
extra_scripts = pre:set_version.py
build_flags =
    -DARCH_ESP32C6
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

[env:m5stack_unit_c6l]
extends = esp32c6_base
board = esp32-c6-devkitc-1
build_flags =
    ${esp32c6_base.build_flags}
    -DBOARD_M5STACK_UNIT_C6L

; =============================================================================
; RP2040 Boards
; =============================================================================

[rp2040_base]
platform = raspberrypi
framework = arduino
build_flags =
    -DARCH_RP2040
build_src_filter =
    +<main.cpp>
    +<core/>
    +<radio/>
    +<network/>
    +<hardware/**/*>
    +<ui/>
    +<utils/>

[env:rak11310]
extends = rp2040_base
board = rakwireless_rak11300
build_flags =
    ${rp2040_base.build_flags}
    -DBOARD_RAK11310

[env:rp2040_lora]
extends = rp2040_base
board = rpipico
build_flags =
    ${rp2040_base.build_flags}
    -DBOARD_RP2040_LORA

[env:rpi_pico]
extends = rp2040_base
board = rpipico
build_flags =
    ${rp2040_base.build_flags}
    -DBOARD_RPI_PICO

[env:rpi_pico_w]
extends = rp2040_base
board = rpipicow
build_flags =
    ${rp2040_base.build_flags}
    -DBOARD_RPI_PICO_W
